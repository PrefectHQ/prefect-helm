name: Release Helm Chart

on:
  push:
    tags:
      - "*\\.*\\.*"  # only run on version tags

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get the version tags
        id: get_version
        run: |
          # Enable pipefail so git command failures do not result in null versions downstream
          set -x

          echo ::set-output name=VERSION::$(echo $GITHUB_REF | cut -d / -f 3)

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v1
        with:
          version: v3.8.1

      - name: Prepare GPG key for signing
        run: |
          gpg_dir=/tmp/.gpg
          mkdir "$gpg_dir"
          keyring="$gpg_dir/secring.gpg"
          base64 -d <<< "$GPG_KEYRING_BASE64" > "$keyring"
          passphrase_file="$gpg_dir/passphrase"
          echo "$GPG_PASSPHRASE" > "$passphrase_file"
          echo "SIGN_PASSPHRASE_FILE=$passphrase_file" >> "$GITHUB_ENV"
          echo "SIGN_KEYRING=$keyring" >> "$GITHUB_ENV"
        env:
          GPG_KEYRING_BASE64: "${{ secrets.GPG_KEYRING_BASE64 }}"
          GPG_PASSPHRASE: "${{ secrets.GPG_PASSPHRASE }}"

      - name: Add dependency chart repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami

      - name: Package Agent helm chart
        run: |
          mkdir /tmp/chart
          cd charts/prefect-agent
          # Update the chart version tag
          sed -i "s/^version:.*$/version: \"$VERSION\"/" Chart.yaml
          helm package prefect-agent \
            --destination /tmp/chart \
            --dependency-update \
            --version $VERSION \
            --app-version $VERSION \
            --sign --key 'jamie@prefect.io' \
            --keyring $SIGN_KEYRING \
            --passphrase-file $SIGN_PASSPHRASE_FILE
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}
          SIGN_KEYRING: ${{ env.SIGN_KEYRING }}
          SIGN_PASSPHRASE_FILE: ${{ env.SIGN_PASSPHRASE_FILE }}

      - name: Update chart index
        run: |
          git stash  # Stash changes to the values.yaml so checkout doesn't complain
          git checkout gh-pages
          helm repo index /tmp/chart --url https://prefecthq.github.io/prefect-helm/charts --merge ./index.yaml

      - name: Commit and push
        run: |
          cp /tmp/chart/index.yaml .
          cp /tmp/chart/prefect-agent-$VERSION.* ./charts
          git add ./index.yaml ./charts/prefect-agent-$VERSION.*
          git commit -m "Release $VERSION"
          git push origin gh-pages
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}






















# ---
# name: Release Charts

# on:
#   push:
#     branches:
#      - "main"
#     # tags:
#       # - "*\\.*\\.*"  # only run on version tags
#       # testing

# jobs:
#   release:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v2
#         with:
#           fetch-depth: 0

#       - name: Configure Git
#         run: |
#           git config user.name "$GITHUB_ACTOR"
#           git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

#       - name: Install Helm
#         uses: azure/setup-helm@v1
#         with:
#           version: v3.8.1

#       # - name: Prepare GPG key
#       #   run: |
#       #     gpg_dir=.cr-gpg
#       #     mkdir "$gpg_dir"
#       #     keyring="$gpg_dir/secring.gpg"
#       #     base64 -d <<< "$GPG_KEYRING_BASE64" > "$keyring"
#       #     passphrase_file="$gpg_dir/passphrase"
#       #     echo "$GPG_PASSPHRASE" > "$passphrase_file"
#       #     echo "CR_PASSPHRASE_FILE=$passphrase_file" >> "$GITHUB_ENV"
#       #     echo "CR_KEYRING=$keyring" >> "$GITHUB_ENV"
#       #   env:
#       #     GPG_KEYRING_BASE64: "${{ secrets.GPG_KEYRING_BASE64 }}"
#       #     GPG_PASSPHRASE: "${{ secrets.GPG_PASSPHRASE }}"
#       - name: Run chart-releaser
#         uses: helm/chart-releaser-action@v1.4.0
#         # with:
#           # key: george@prefect.io
#           # sign: true
#         env:
#           CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
#           CR_SKIP_EXISTING: true
